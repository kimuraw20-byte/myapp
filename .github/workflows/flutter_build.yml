name: Flutter Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      # 1. Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Ø¹Ø±Ø¶ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù„ØªØ´Ø®ÙŠØµ
      - name: Diagnose project structure
        run: |
          echo "ğŸ“ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:"
          find . -name "*.gradle" -o -name "pubspec.yaml" -o -name "AndroidManifest.xml" | head -20
          echo ""
          echo "ğŸ“‹ Ù…Ø­ØªÙˆÙ‰ android directory:"
          ls -la android/ || echo "âŒ Ù…Ø¬Ù„Ø¯ android ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          ls -la android/app/ || echo "âŒ Ù…Ø¬Ù„Ø¯ android/app ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"

      # 3. ØªØ­Ø¯ÙŠØ« Gradle Plugin ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      - name: Update Android Gradle Plugin
        run: |
          if [ -f "android/build.gradle" ]; then
            echo "ğŸ”§ ØªØ­Ø¯ÙŠØ« Ø¥ØµØ¯Ø§Ø± Gradle Plugin..."
            sed -i 's/com\.android\.tools\.build:gradle:[0-9]\.[0-9]\.[0-9]/com.android.tools.build:gradle:8.1.1/g' android/build.gradle
            sed -i 's/com\.android\.tools\.build:gradle:[0-9]\.[0-9]/com.android.tools.build:gradle:8.1.1/g' android/build.gradle
            echo "âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"
            cat android/build.gradle | grep "com.android.tools.build"
          else
            echo "âŒ Ù…Ù„Ù android/build.gradle ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          fi

      # 4. ØªØ«Ø¨ÙŠØª Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.1'
          channel: 'stable'
          cache: true

      # 5. Ø¥Ø¹Ø¯Ø§Ø¯ JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 6. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      - name: Verify environment
        run: |
          echo "ğŸ”„ Ø¥ØµØ¯Ø§Ø± Flutter:"
          flutter --version
          echo ""
          echo "ğŸ”„ Ø¥ØµØ¯Ø§Ø± Dart:"
          dart --version
          echo ""
          echo "ğŸ”„ Ø¥ØµØ¯Ø§Ø± Java:"
          java -version

      # 7. ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„
      - name: Deep clean
        run: |
          echo "ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„..."
          flutter clean
          rm -rf build/
          rm -rf .dart_tool/
          if [ -d "android" ]; then
            cd android
            ./gradlew clean --no-daemon || echo "Gradle clean failed"
            cd ..
          fi

      # 8. ØªØ«Ø¨ÙŠØª dependencies Ù…Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„
      - name: Install dependencies with details
        run: |
          echo "ğŸ“¦ ØªØ«Ø¨ÙŠØª dependencies..."
          flutter pub get --verbose
          echo ""
          echo "ğŸŒ³ Ø´Ø¬Ø±Ø© dependencies:"
          flutter pub deps

      # 9. ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      - name: Analyze code
        run: |
          echo "ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯..."
          flutter analyze --fatal-infos --fatal-warnings || echo "ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù‡ ØªØ­Ø°ÙŠØ±Ø§Øª"

      # 10. Ø¨Ù†Ø§Ø¡ APK Ù…Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
      - name: Build APK with multiple strategies
        run: |
          echo "ğŸ—ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©..."
          flutter build apk --release --verbose 2>&1 | tee build_log.txt || \
          (echo "âŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙØ´Ù„Øª - Ø¬Ø±Ø¨ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©..." && \
          flutter build apk --release --no-tree-shake-icons --no-obfuscate --verbose 2>&1 | tee -a build_log.txt) || \
          (echo "âŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙØ´Ù„Øª - Ø¬Ø±Ø¨ Gradle Ù…Ø¨Ø§Ø´Ø±Ø©..." && \
          cd android && \
          ./gradlew assembleRelease --no-daemon --info 2>&1 | tee -a ../build_log.txt && \
          cd ..)

      # 11. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù APK Ø§Ù„Ù…Ø¨Ù†Ù‰
      - name: Find built APK
        run: |
          echo "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù APK..."
          find . -name "*.apk" -type f | head -10
          find . -path "*/outputs/*" -name "*.apk" -type f | head -10
          ls -la build/app/outputs/ || echo "âŒ Ù…Ø¬Ù„Ø¯ outputs ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          ls -la build/app/outputs/flutter-apk/ || echo "âŒ Ù…Ø¬Ù„Ø¯ flutter-apk ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
          ls -la android/app/build/outputs/ || echo "âŒ Ù…Ø¬Ù„Ø¯ android outputs ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"

      # 12. Ø±ÙØ¹ APK Ø¥Ø°Ø§ ÙˆØ¬Ø¯
      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/apk/release/app-release.apk
            android/app/build/outputs/apk/release/app-release.apk
          retention-days: 7

      # 13. Ø±ÙØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¯Ø§Ø¦Ù…Ø§Ù‹
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build_log.txt
            android/build.gradle
            pubspec.yaml
          retention-days: 3

      # 14. Ø¥Ø´Ø¹Ø§Ø± Ù…ÙØµÙ„ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø©
      - name: Detailed build result
        if: always()
        run: |
          echo "ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡: ${{ job.status }}"
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù†Ø¬Ø­!"
            echo "ğŸ“¦ APK Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Artifacts"
          else
            echo "âŒ Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙØ´Ù„"
            echo "ğŸ” Ø§ÙØ­Øµ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙÙŠ Artifacts"
            echo "ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† 'error' Ø£Ùˆ 'exception' ÙÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª"
          fi
